#!/bin/sh
#
# Pre-commit hook for MrSE
# Runs checks before allowing commit

set -e

echo "üîç Running pre-commit checks..."

# Check if we're committing to main branch
branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')
if [ "$branch" = "main" ]; then
    echo "‚ö†Ô∏è  WARNING: Committing directly to main branch!"
    echo "Consider using a feature branch for development."
    read -p "Continue? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå Commit cancelled"
        exit 1
    fi
fi

# Check for sensitive information
echo "üîê Checking for sensitive data..."
if git diff --cached --name-only | xargs grep -l -E "(password|secret|key|token)" 2>/dev/null; then
    echo "‚ö†Ô∏è  WARNING: Potential sensitive data found in staged files!"
    echo "Files containing sensitive keywords:"
    git diff --cached --name-only | xargs grep -l -E "(password|secret|key|token)" 2>/dev/null || true
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå Commit cancelled"
        exit 1
    fi
fi

# Check for .env file
if git diff --cached --name-only | grep -q "^\.env$"; then
    echo "üö® ERROR: .env file should not be committed!"
    echo "Add .env to .gitignore and remove from staging."
    exit 1
fi

# TypeScript compilation check
if command -v npm >/dev/null 2>&1; then
    echo "üîß Running TypeScript compilation check..."
    if ! npm run build >/dev/null 2>&1; then
        echo "‚ùå TypeScript compilation failed!"
        echo "Fix compilation errors before committing."
        exit 1
    fi
    echo "‚úÖ TypeScript compilation passed"
fi

# Check commit message format
commit_regex='^(feat|fix|docs|style|refactor|perf|test|chore|security|breaking)(\(.+\))?: .{1,50}'
if ! head -1 "$1" | grep -qE "$commit_regex"; then
    echo "‚ùå Invalid commit message format!"
    echo "Use: <type>: <description>"
    echo "Types: feat, fix, docs, style, refactor, perf, test, chore, security, breaking"
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"